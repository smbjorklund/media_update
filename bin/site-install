#!/bin/sh

SITE_DIR=${1:-uib.no}
PROFILE=${2:-uib}
DATABASE=pgsql://user1:pass1@glory.uib.no/db1
DATABASE=sqlite:sites/$SITE_DIR/files/site.db

cd drupal || exit 1

if [ -e sites/$SITE_DIR ]; then
    echo "drupal/sites/$SITE_DIR already exists, aborting."
    exit 1
fi

set -x
drush site-install $PROFILE --db-url=$DATABASE --sites-subdir=$SITE_DIR --site-name=$SITE_DIR --site-mail="w3@it.uib.no" --site-name="Universitetet i Bergen" --account-name=admin --account-mail="w3@it.uib.no" --account-pass=admin --clean-url --verbose --yes || exit 1

cat <<EOT >sites/default/settings.php
No default site.  You need to visit <a href="http://$SITE_DIR">$SITE_DIR</a> instead.
<?php
exit;
EOT

cd sites/$SITE_DIR || exit 1

chmod u+w . settings.php
find files -type d | xargs chmod 777
find files -type f | xargs chmod 666

cat <<'EOT' >>drushrc.php
<?php
$options['structure-tables'] = array(
    'common' => array(
       'cache', 'cache_block', 'cache_bootstrap', 'cache_field', 'cache_filter',
       'cache_form', 'cache_image', 'cache_menu', 'cache_page', 'cache_path', 'cache_update',
       'history', 'sessions', 'watchdog',
    ),
);
EOT
(cd ../../.. && rm -f site && ln -s drupal/sites/$SITE_DIR site)
(cd ../../.. && bin/sql-dump $SITE_DIR)

git init
git add settings.php drushrc.php dump.sql
git commit -m "site-install"
git branch -m master site/$SITE_DIR
git remote add origin git@git.uib.no:site/w3.uib.no.git

set +x
echo "Run 'cd site && git push origin site/$SITE_DIR' to upload"
