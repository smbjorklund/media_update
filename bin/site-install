#!/bin/sh

SITE_DIR=${1:-uib.no}
DATABASE=pgsql://user1:pass1@glory.uib.no/db1
DATABASE=sqlite:sites/$SITE_DIR/files/site.db

cd drupal || exit 1

if [ -e sites/$SITE_DIR ]; then
    echo "drupal/sites/$SITE_DIR already exists, aborting."
    exit 1
fi

set -x
drush site-install minimal --db-url=$DATABASE --sites-subdir=$SITE_DIR --verbose --yes

cd sites/$SITE_DIR || exit 1

chmod u+w . settings.php
find files -type d | xargs chmod 777
find files -type f | xargs chmod 666

cat <<'EOT' >>drushrc.php
<?php
$options['structure-tables'] = array(
    'common' => array(
       'cache', 'cache_block', 'cache_bootstrap', 'cache_field', 'cache_filter',
       'cache_form', 'cache_image', 'cache_menu', 'cache_page', 'cache_path', 'cache_update',
       'history', 'sessions', 'watchdog',
    ),
);
EOT
(cd ../../.. && bin/sql-dump $SITE_DIR)

git init
git add settings.php drushrc.php dump.sql
git commit -m "site-install"
git branch -m master site/$SITE_DIR
git remote add origin git@git.uib.no:site/w3.uib.no.git

set +x
echo "Run 'git push origin site/$SITE_DIR' to upload"
