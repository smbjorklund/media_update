#!/bin/bash

# Parameters to this script

# First parameter is site, eg. 'w3.uib.local'
# The default setup uses sqlite for local test installation
#
# When using postgres for test, the
# second parameter should be 'postgres', and
# third parameter an optional postgres database name (default '<user>-db1')

SITE_DIR=${1:-uib.no}
#PROFILE=${2:-uib}
PROFILE="uib"
#DATABASE=pgsql://user1:pass1@glory.uib.no/db1
DATABASE=sqlite:sites/$SITE_DIR/files/site.db
if [ "$2" = "postgres" ]; then
	if [ -n "$3" ]; then
		pgdb=$3
	else
		pgdb="$USER-db1"
	fi
	# Attempt to obtain information from postgres password file
	pgpsw=$HOME/.pgpass
	if [ -e $pgpsw ]; then
       		pgpswln=`cat $pgpsw`
       		pgpswlnm=`echo $pgpswln | sed 's/*/#/g'`
        	declare -a arr=(`echo $pgpswlnm | sed 's/:/ /g'`)
		DATABASE=pgsql://${arr[3]}:${arr[4]}@${arr[0]}/$pgdb
	else
		# Using a default statement
		DATABASE=pgsql://postgres@localhost/$pgdb
	fi
fi
# Save command line parameters for future reinstalls
echo "$1 $2 $3" > sitecmdline

cd drupal || exit 1

if [ -e sites/$SITE_DIR ]; then
    echo "drupal/sites/$SITE_DIR already exists, aborting."
    exit 1
fi

set -x
drush site-install $PROFILE --db-url=$DATABASE --sites-subdir=$SITE_DIR --site-name=$SITE_DIR --site-mail="w3@it.uib.no" --site-name="Universitetet i Bergen" --account-name=admin --account-mail="w3@it.uib.no" --account-pass=admin --clean-url --verbose --yes || exit 1

# The installer sometimes override variables that we try to enforce with uib_feature_setup.
# Fix that by explictly reverting those changes.
drush -l http://$SITE_DIR features-revert --yes uib_feature_setup

cat <<EOT >sites/default/settings.php
No default site.  You need to visit <a href="http://$SITE_DIR">$SITE_DIR</a> instead.
<?php
exit;
EOT

cd sites/$SITE_DIR || exit 1

chmod u+w . settings.php
find files -type d | xargs chmod 777
find files -type f | xargs chmod 666

cat <<'EOT' >>drushrc.php
<?php
$options['structure-tables'] = array(
    'common' => array(
       'cache', 'cache_block', 'cache_bootstrap', 'cache_field', 'cache_filter',
       'cache_form', 'cache_image', 'cache_menu', 'cache_page', 'cache_path', 'cache_update',
       'history', 'sessions', 'watchdog',
    ),
);
EOT
(cd ../../.. && rm -f site && ln -s drupal/sites/$SITE_DIR site)
(cd ../../.. && bin/sql-dump $SITE_DIR)

git init
git add settings.php drushrc.php dump.sql
git commit -m "site-install"
git branch -m master site/$SITE_DIR
git remote add origin git@git.uib.no:site/w3.uib.no.git

set +x
echo "Run 'cd site && git push origin site/$SITE_DIR' to upload"
