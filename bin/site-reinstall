#!/bin/sh

# syntax reinstall [--discard] [postgres] [databasename]
# if --discard is given as first arg, skips backup of database+site

test -L site || exit 1
SITE=$(basename $(readlink site))
BACKUP=true
rm -fr var/private

if [ "$1" = "--discard" ]; then
    BACKUP=false
    shift
    echo "Skipping backup of database+site"
fi

set -x
#test -d drupal/sites/$SITE && mv drupal/sites/$SITE drupal/sites/$SITE-$(date +%Y%m%dT%H%M)
if [ -d drupal/sites/$SITE ]; then
    if $BACKUP ; then
        bin/sql-dump
	      mv drupal/sites/$SITE drupal/sites/$SITE-$(date +%Y%m%dT%H%M)
    else
        rm -rf drupal/sites/$SITE
    fi
fi

if [ -e sitecmdline ];then
   read -r CMDLINE < sitecmdline
	if bin/site-install $CMDLINE; then
		bin/site-drush migrate-import --verbose --all
		bin/site-drush uib-migrate-build-menu --verbose
		bin/site-drush pm-enable --yes uib_devel
   fi
else
   if bin/site-install $SITE $1 $2; then
      bin/site-drush migrate-import --verbose --all
      bin/site-drush uib-migrate-build-menu --verbose
      bin/site-drush pm-enable --yes uib_devel
   fi
fi

