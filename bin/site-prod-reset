#!/bin/bash

set -x

PGHOST="glory.uib.no"
PGDB="$USER-db1"
PGUSER="user1"

test -L site || exit 1
SITE=$(basename $(readlink site))

rsync -rltDih --delete vengeance.uib.no:/prod_nettapp_w3/sites/w3.uib.no/files/ site/files/
find site/files -type d | xargs chmod 777
find site/files -type f | xargs chmod 666

rsync -avh vengeance.uib.no:/prod_nettapp_w3/pg_dump/w3.uib.no.sql site/w3.uib.no.sql
perl -pe "s/\bw3_(?:user|admin)\b/$PGUSER/g" site/w3.uib.no.sql | psql --echo-queries --host $PGHOST $PGDB $PGUSER >site/pg.out 2>&1
bin/pg_error_report site/pg.out

rm -rf drupal/sites/w3.uib.no
ln -s $SITE drupal/sites/w3.uib.no

bin/site-drush cc all
