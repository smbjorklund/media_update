#!/bin/bash

PGUSER=$(php --run 'include "site/settings.php"; print($databases["default"]["default"]["username"]);')
PSQL=$(bin/site-drush --verbose=0 sql-connect)
PGDUMP_HOST=${PGDUMP_HOST:-vengeance.uib.no}
PGDUMP_HOST_PREFIX=$PGDUMP_HOST:
PGDUMP_HOST_RUN="ssh $PGDUMP_HOST"

set -x

if [ $(hostname) == $PGDUMP_HOST ]; then
    PGDUMP_HOST_PREFIX=
    PGDUMP_HOST_RUN="sh -c"
fi

test -L site || exit 1
SITE=$(basename $(readlink site))

RELEASE=$1
if [ "$RELEASE" != "" ]; then
    set -- $(bin/release-dumps $RELEASE)
    if [ "$1" != $RELEASE ]; then
	echo "Don't have any dumps for release $RELEASE"
	exit 1
    fi
    COMMIT=R$RELEASE
    DUMP=$3
else
    COMMIT=origin/prod
    DUMP_DIR=/prod_nettapp_w3/pg_dump
    DUMP=$($PGDUMP_HOST_RUN "ls -t $DUMP_DIR/*.sql | head -n 1")
fi

set -x

rsync -rltDih --delete $PGDUMP_HOST_PREFIX/prod_nettapp_w3/sites/w3.uib.no/files/ site/files/ --exclude=/js --exclude=/css --exclude=/ctools --exclude=/styles --exclude=*.pdf --exclude=*.mp3 --exclude=*.mp4

DOTGZ=""
case $DUMP in *.gz) DOTGZ=".gz";; esac
rsync -avh $PGDUMP_HOST_PREFIX$DUMP site/w3.uib.no.sql$DOTGZ
if [ "$DOTGZ" != "" ]; then
    gunzip -f site/w3.uib.no.sql$DOTGZ
fi

bin/site-drush sql-drop --yes
bin/filter-prod-dump --map-user $PGUSER --unlogged --skip-revision-data site/w3.uib.no.sql | $PSQL --echo-queries >site/pg.out 2>&1
bin/pg_error_report --ignore-drop site/pg.out

# Need to set up w3.uib.no as site alias since it's hardcoded a few places in the database dump
rm -rf drupal/sites/w3.uib.no
ln -s $SITE drupal/sites/w3.uib.no

git fetch
git checkout $COMMIT || exit 1;
git submodule update
compass compile --force themes/uib_zen
bin/site-drush cc all

find site/files/ -type d | xargs chmod 777
find site/files/ -type f | xargs chmod 666
