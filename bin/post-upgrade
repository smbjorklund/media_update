#!/bin/bash

# This script runs at the end of the upgrade process to the next release.
# It can be use to perform migrations or other manipulations of the content
# and configuration of the site.

REL=7.6

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

set -x
# Since RTS-6413 now adds ou ref for users
bin/site-drush uib-sebra-users --verbose --limit=0

# Update translation strings
bin/update-norsk

# Update library content
bin/site-drush php-script content-ub --verbose

# Migrate
date +%FT%T
bin/site-drush migrate-import --verbose Area --strict=0 --area_subset=uib_areas_subset_rest76.txt
bin/site-drush migrate-import --verbose NavPage --strict=0 --area_subset=uib_areas_subset_rest76.txt
bin/site-drush migrate-import --verbose InfoPage --strict=0 --area_subset=uib_areas_subset_rest76.txt
bin/site-drush migrate-import --verbose News --strict=0 --area_subset=uib_areas_subset_rest76.txt
bin/site-drush migrate-import --verbose Event --strict=0 --area_subset=uib_areas_subset_rest76.txt
bin/site-drush migrate-import --verbose Testimonial --strict=0 --area_subset=uib_areas_subset_rest76.txt
date +%FT%T

# Build area menu for migrated content
bin/site-drush uib-migrate-build-menu --verbose

# Split Area menu for newly migrated content
bin/site-drush uib-area-menu-chk
bin/site-drush uib-area-split-menu --verbose
bin/site-drush uib-area-menu-to-relation

# Fill in missing parents after migration
date +%FT%T
bin/site-drush php-script area-parents --force

# Make sure the cache is really blenda-clean
bin/site-drush cc all
