#!/bin/bash

set -x

REL=7.5

if git tag | grep -q R$REL; then
    echo "Disabled after $REL has been released";
    exit 1
fi

bin/site-drush pm-disable --yes menu_block
bin/site-drush pm-uninstall --yes menu_block
bin/site-drush php-script geofield-data-relocation --verbose

# Migrate
date +%FT%T
bin/site-drush migrate-import --verbose Area --strict=0 --area_subset=uib_areas_subset_rest75.txt
bin/site-drush migrate-import --verbose NavPage --strict=0 --area_subset=uib_areas_subset_rest75.txt
bin/site-drush migrate-import --verbose InfoPage --strict=0 --area_subset=uib_areas_subset_rest75.txt
bin/site-drush migrate-import --verbose News --strict=0 --area_subset=uib_areas_subset_rest75.txt
bin/site-drush migrate-import --verbose Event --strict=0 --area_subset=uib_areas_subset_rest75.txt
bin/site-drush migrate-import --verbose Testimonial --strict=0 --area_subset=uib_areas_subset_rest75.txt
date +%FT%T

# Build area menu for migrated content
bin/site-drush uib-migrate-build-menu --verbose

# Split Area menu for newly migrated content
bin/site-drush uib-area-menu-chk
bin/site-drush uib-area-split-menu --verbose
bin/site-drush uib-area-menu-to-relation

# Fill in missing parents after migration
date +%FT%T
bin/site-drush php-script area-parents --force

# Make sure the cache is really blenda-clean
bin/site-drush cc all
