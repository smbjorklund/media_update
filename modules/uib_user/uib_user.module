<?php
/**
 * @file
 * Code for the UiB Feature User feature.
 */

include_once 'uib_user.features.inc';

/**
 * Implements hook_username_alter().
 *
 * The UiB user names are too ugly to show to regular people, so we want
 * users to be presented by their "<first name> <last name>".
 */

function uib_user_username_alter(&$name, $account) {
  if (isset($account->uid)) {
    $user = user_load($account->uid);
    if (!empty($user->field_uib_first_name)) {
      $name = $user->field_uib_first_name['und'][0]['safe_value'];
      if (!empty($user->field_uib_last_name)) {
        $name = "$name " . $user->field_uib_last_name['und'][0]['safe_value'];
      }
    }
    else {
      $name = "[$name]";
    }
  }
}

function uib_user_user_login(&$edit, $account) {
  if ( (in_array('level 1', $account->roles, TRUE)) || ($account->uid == 1) || (in_array('level 2', $account->roles, TRUE)) || (in_array('level 3', $account->roles, TRUE)) ) {
    $edit['redirect'] = 'webdesk';
  }
  else {
    $edit['redirect'] = 'user';
  }
}

/**
 * Implements hook_theme().
 *
 */
function uib_user_theme($existing, $type, $theme, $path) {
  return array(
    'views_view_field__user_block__edit_node' => array(
      'arguments' => array('view' => FALSE, 'field' => FALSE, 'row' => FALSE),
      'original hook' => 'views_view_field',
    ),
  );
}

function theme_views_view_field__user_block__edit_node($view) {
  global $user;
  global $language;
  $alias = drupal_get_path_alias('user/' . $user->uid);

  if ('user/' . $user->uid != $alias) {
    $url = '<a href=http://uib.no/' . $alias . '>' . t('Edit account') . '</a';
    return $url;
  }
}

/**
 * Implements hook_form_alter().
 *
 */
function uib_user_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'user_login') {
    array_unshift($form['#validate'], 'uib_user__username_lc');
  }
}

/**
 * Always lowercase username.
 *
 */
function uib_user__username_lc($form, &$form_state) {
  if (!empty($form_state['values']['name'])) {
    $form_state['values']['name'] = drupal_strtolower($form_state['values']['name']);
  }
}
